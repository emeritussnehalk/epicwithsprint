<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Epic Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    .epic-card {
      border-left: 4px solid #3b82f6;
      transition: all 0.2s ease;
    }
    .epic-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .epic-card.selected {
      border-left-color: #10b981;
      background-color: #f0fdf4;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      text-align: left;
      padding: 12px;
      background-color: #f8fafc;
      font-weight: 600;
      color: #475569;
      cursor: pointer;
    }
    td {
      padding: 12px;
      border-top: 1px solid #e2e8f0;
    }
    tr:hover {
      background-color: #f8fafc;
    }
    .file-drop-area {
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    .file-drop-area:hover, .file-drop-area.active {
      border-color: #3b82f6;
      background-color: #f0f7ff;
    }
    .loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Toggle button styles */
    .mode-toggle-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      border: 1px solid #cbd5e1;
      background-color: #ffffff;
      color: #334155;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .mode-toggle-btn.active {
      background-color: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
    }
  </style>
</head>
<body>
  <div class="dashboard-container p-6 max-w-screen-xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Epic Detail Dashboard</h1>

    <!-- Source toggle + input panels -->
    <div id="file-upload-section" class="mb-8 space-y-4">

      <!-- Toggle row -->
      <div class="flex flex-wrap items-center gap-3">
        <span class="text-sm text-slate-600">Data source:</span>
        <button
          type="button"
          class="mode-toggle-btn active"
          data-mode-toggle="json">
          Use JSON file
        </button>
        <button
          type="button"
          class="mode-toggle-btn"
          data-mode-toggle="api">
          Use Jira API
        </button>
      </div>

      <!-- JSON mode panel -->
      <div id="json-mode-panel">
        <div class="file-drop-area" id="drop-area">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Upload JSON export</h2>
          <p class="text-gray-500 mb-2">Drag & drop your JSON file here or</p>
          <input accept=".json" class="hidden" id="fileInput" type="file" />
          <button
            class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded"
            onclick="document.getElementById('fileInput').click()">
            Browse Files
          </button>
        </div>
      </div>

      <!-- Jira API mode panel -->
      <div id="api-mode-panel" class="hidden">
        <div class="p-4 border border-slate-200 rounded-lg bg-white">
          <h2 class="text-lg font-semibold text-gray-800 mb-2">Fetch from Jira API</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Jira Site URL</label>
              <input id="jira-url" type="text"
                     placeholder="https://your-domain.atlassian.net"
                     class="w-full p-2 border border-gray-300 rounded-md" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email (Jira login)</label>
              <input id="jira-email" type="email"
                     placeholder="you@company.com"
                     class="w-full p-2 border border-gray-300 rounded-md" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">API Token</label>
              <input id="jira-token" type="password"
                     placeholder="Jira API token"
                     class="w-full p-2 border border-gray-300 rounded-md" />
              <p class="text-xs text-gray-500 mt-1">
                Create a token from Atlassian account → Security → API tokens.
              </p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">JQL</label>
              <input id="jira-jql" type="text"
                     placeholder="project = PEJ AND issuetype in (Epic, Story)"
                     class="w-full p-2 border border-gray-300 rounded-md" />
            </div>
            <button
              id="jira-fetch-btn"
              class="mt-2 bg-emerald-500 hover:bg-emerald-600 text-white font-medium py-2 px-4 rounded w-full">
              Fetch from Jira
            </button>
          </div>
        </div>
      </div>

    </div>

    <div class="hidden" id="dashboard-content">
      <section class="filter-section p-6 mb-8 bg-white rounded shadow">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Global Filters</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Product Manager</label>
            <select id="pm-filter" class="block w-full p-2 border border-gray-300 rounded-md" multiple></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Sprint</label>
            <select id="sprint-filter" class="block w-full p-2 border border-gray-300 rounded-md" multiple></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="status-filter" class="block w-full p-2 border border-gray-300 rounded-md" multiple></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">University</label>
            <select id="university-filter" class="block w-full p-2 border border-gray-300 rounded-md" multiple></select>
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition" id="apply-global-filters">Apply Filters</button>
        </div>
      </section>

      <section class="epic-section p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Epic Selection</h2>
        <p class="text-sm text-gray-600 mb-4"><span id="epic-count">0</span> epics found</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="epic-list"></div>
      </section>

      <section class="detail-section p-6">
        <div id="epic-details"></div>
      </section>
    </div>
  </div>

  <div class="loading hidden" id="loading">
    <div class="spinner"></div>
  </div>

<script>
  let allData = [];
  let epics = [];
  let selectedEpics = new Set();
  const sortStates = {};

  // ---------- EXISTING JSON UPLOAD HANDLERS ----------
  document.getElementById('fileInput').addEventListener('change', handleFileSelect);
  document.getElementById('drop-area').addEventListener('drop', handleDrop, false);
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    document.getElementById('drop-area').addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
    }, false);
  });

  document.getElementById('apply-global-filters').addEventListener('click', () => {
    displayEpics(applyGlobalFilters());
    clearEpicDetails();
  });

  function handleFileSelect(e) {
    handleFiles(e.target.files);
  }

  function handleDrop(e) {
    handleFiles(e.dataTransfer.files);
  }

  function handleFiles(files) {
    if (files.length > 0) {
      const file = files[0];
      if (file.type === 'application/json' || file.name.endsWith('.json')) {
        document.getElementById('loading').classList.remove('hidden');
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const jsonData = JSON.parse(e.target.result);
            processData(jsonData);
            document.getElementById('loading').classList.add('hidden');
            showDashboard();
          } catch (error) {
            document.getElementById('loading').classList.add('hidden');
            alert('Error parsing JSON: ' + error.message);
          }
        };
        reader.readAsText(file);
      } else {
        alert('Please upload a JSON file.');
      }
    }
  }

  function showDashboard() {
    document.getElementById('file-upload-section').classList.add('hidden');
    document.getElementById('dashboard-content').classList.remove('hidden');
  }

  function convertJiraDate(jiraDateString) {
    if (!jiraDateString) return "";
    const regex = /^(\d{1,2})\/([A-Za-z]{3})\/(\d{2})/;
    const match = jiraDateString.match(regex);
    if (!match) return "";
    const day = match[1].padStart(2, "0");
    const monthMap = {
      Jan:"01", Feb:"02", Mar:"03", Apr:"04", May:"05", Jun:"06",
      Jul:"07", Aug:"08", Sep:"09", Oct:"10", Nov:"11", Dec:"12"
    };
    const month = monthMap[match[2]];
    const year = "20" + match[3];
    return `${day}/${month}/${year}`;
  }

  function processData(data) {
    allData = Array.isArray(data) ? data : [data];
    const epicMap = new Map();

    // First pass: seed epics
    allData.forEach(item => {
      if (item["Issue Type"] === "Epic") {
        epicMap.set(String(item["Issue key"]), {
          id: String(item["Issue key"]),
          summary: item["Summary"] || "Unknown Epic",
          dueDate: item["Custom field (Due Date)"] || "",
          productManager: item["Custom field (Product Manager)"] || "Not Assigned",
          stories: [],
          totalStoryPoints: 0
        });
      }
    });

    // Second pass: attach stories to epics
    allData.forEach(item => {
      if (item["Issue Type"] === "Story" && item["Parent key"]) {
        const epicId = String(item["Parent key"]);
        if (!epicMap.has(epicId)) {
          epicMap.set(epicId, {
            id: epicId,
            summary: item["Parent summary"] || "Unknown Epic",
            dueDate: "",
            productManager: "Not Assigned",
            stories: [],
            totalStoryPoints: 0
          });
        }
        const epic = epicMap.get(epicId);
        epic.stories.push({
          issueKey: item["Issue key"] || "",
          summary: item.Summary || "",
          sprint: item.Sprint || "Not Assigned",
          status: item.Status || "Not Assigned",
          storyPoints: item["Custom field (Story Points)__1"] || 0,
          university: item["Custom field (University Name)"] || "Not Assigned",
          skillSet: item["Custom field (Skill Set)"] || "Not Assigned",
          productManager: item["Custom field (Product Manager)"] || "Not Assigned",
          dueDate: item["Custom field (Due Date)"] || ""
        });
        if (item["Custom field (Story Points)__1"]) {
          epic.totalStoryPoints += parseFloat(item["Custom field (Story Points)__1"]) || 0;
        }
      }
    });

    epics = Array.from(epicMap.values());
    initializeFilters();
    displayEpics();
  }

  function initializeFilters() {
    const pmFilter = document.getElementById('pm-filter');
    const sprintFilter = document.getElementById('sprint-filter');
    const statusFilter = document.getElementById('status-filter');
    const universityFilter = document.getElementById('university-filter');
    const sets = { pm: new Set(), sprint: new Set(), status: new Set(), university: new Set() };

    allData.forEach(item => {
      if (item["Custom field (Product Manager)"]) sets.pm.add(item["Custom field (Product Manager)"]);
      if (item.Sprint) sets.sprint.add(item.Sprint);
      if (item.Status) sets.status.add(item.Status);
      if (item["Custom field (University Name)"]) sets.university.add(item["Custom field (University Name)"]);
    });

    allData.forEach(item => {
      if (item["Issue Type"] === "Epic" && item["Custom field (Product Manager)"]) {
        sets.pm.add(item["Custom field (Product Manager)"]);
      }
    });

    populateFilter(pmFilter, sets.pm);
    populateFilter(sprintFilter, sets.sprint);
    populateFilter(statusFilter, sets.status);
    populateFilter(universityFilter, sets.university);
  }

  function populateFilter(selectElement, values) {
    selectElement.innerHTML = '<option value="All" selected>All</option>';
    Array.from(values).sort().forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      selectElement.appendChild(option);
    });
  }

  function applyGlobalFilters() {
    const pmFilter = getSelectedValues('pm-filter');
    const sprintFilter = getSelectedValues('sprint-filter');
    const statusFilter = getSelectedValues('status-filter');
    const universityFilter = getSelectedValues('university-filter');

    return epics.filter(epic => {
      return epic.stories.some(story =>
        (pmFilter.length === 0 || pmFilter.includes(story.productManager)) &&
        (sprintFilter.length === 0 || sprintFilter.includes(story.sprint)) &&
        (statusFilter.length === 0 || statusFilter.includes(story.status)) &&
        (universityFilter.length === 0 || universityFilter.includes(story.university))
      );
    });
  }

  function getSelectedValues(filterId) {
    const selected = Array.from(document.getElementById(filterId).selectedOptions).map(opt => opt.value);
    return selected.includes("All") ? [] : selected;
  }

  function displayEpics(epicsToShow = epics) {
    const epicList = document.getElementById("epic-list");
    const epicCount = document.getElementById("epic-count");
    epicList.innerHTML = "";
    epicCount.textContent = epicsToShow.length;

    epicsToShow.forEach(epic => {
      const card = document.createElement("div");
      card.className = "epic-card p-4 bg-white rounded-md shadow-sm";
      const dueDate = epic.dueDate ? convertJiraDate(epic.dueDate) : "No due date";

      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-semibold text-gray-800 mb-1">${epic.summary}</h3>
            <p class="text-sm text-gray-600 mb-1">Product Manager: ${epic.productManager}</p>
            <p class="text-sm text-gray-600 mb-1">Story Points: ${epic.totalStoryPoints}</p>
            <p class="text-sm text-gray-600">Due: <span class="font-medium">${dueDate}</span></p>
            <p class="text-xs text-gray-500 mt-2">${epic.stories.length} user stories</p>
          </div>
          <input type="checkbox" class="mt-2" data-epic-id="${epic.id}" onchange="toggleEpic('${epic.id}', this.checked)">
        </div>
      `;
      epicList.appendChild(card);
    });
  }

  function toggleEpic(epicId, checked) {
    if (checked) {
      selectedEpics.add(epicId);
    } else {
      selectedEpics.delete(epicId);
    }
    renderDetails();
  }

  function clearEpicDetails() {
    document.getElementById("epic-details").innerHTML = "";
  }

  function renderDetails() {
    const container = document.getElementById("epic-details");
    container.innerHTML = "";

    if (selectedEpics.size === 0) {
      container.innerHTML = "<p class='text-gray-600'>No epics selected.</p>";
      return;
    }

    selectedEpics.forEach(id => {
      const epic = epics.find(e => e.id === id);
      if (!epic) return;

      const dueDate = epic.dueDate ? convertJiraDate(epic.dueDate) : "No due date";

      const filters = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-2 mt-2 mb-4">
          ${createFilterDropdown("Product Manager", "productManager", epic)}
          ${createFilterDropdown("Sprint", "sprint", epic)}
          ${createFilterDropdown("Status", "status", epic)}
          ${createFilterDropdown("University", "university", epic)}
          ${createFilterDropdown("Skill Set", "skillSet", epic)}
        </div>
        <button onclick="filterStories('${id}')" class="bg-green-500 text-white px-3 py-1 rounded">Filter Stories</button>
      `;

      let tableRows = epic.stories.map(s => `
        <tr>
          <td>${s.issueKey}</td>
          <td>${s.summary}</td>
          <td>${s.sprint}</td>
          <td>${s.status}</td>
          <td>${s.storyPoints}</td>
          <td>${s.university}</td>
          <td>${s.skillSet}</td>
        </tr>
      `).join("");

      const table = `
        <table class="text-sm mb-8">
          <thead>
            <tr>
              <th onclick="sortTable('${id}', 'issueKey')">Issue Key ▲▼</th>
              <th onclick="sortTable('${id}', 'summary')">User Story ▲▼</th>
              <th onclick="sortTable('${id}', 'sprint')">Sprint ▲▼</th>
              <th onclick="sortTable('${id}', 'status')">Status ▲▼</th>
              <th onclick="sortTable('${id}', 'storyPoints')">Story Points ▲▼</th>
              <th onclick="sortTable('${id}', 'university')">University ▲▼</th>
              <th onclick="sortTable('${id}', 'skillSet')">Skill Set ▲▼</th>
            </tr>
          </thead>
          <tbody id="story-table-${id}">${tableRows}</tbody>
        </table>
      `;

      const header = `
        <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded mb-6">
          <h3 class="text-lg font-bold text-green-800 mb-2">${epic.summary}</h3>
          <p class="text-sm text-gray-700 mb-1">Product Manager: ${epic.productManager}</p>
          <p class="text-sm text-gray-700 mb-1">Total Story Points: ${epic.totalStoryPoints}</p>
          <p class="text-sm text-gray-700 mb-1">Due Date: ${dueDate}</p>
          <p class="text-sm text-gray-700 mb-3">User Stories: ${epic.stories.length}</p>
          ${filters}
        </div>
        ${table}
      `;

      container.innerHTML += header;
    });
  }

  function createFilterDropdown(label, field, epic) {
    const values = Array.from(new Set(epic.stories.map(s => s[field]))).filter(v => v && v !== "");
    const options = values.map(v => `<option value="${v}">${v}</option>`).join("");
    return `
      <div>
        <label class="block text-xs font-medium text-gray-700">${label}</label>
        <select id="${field}-filter-${epic.id}" class="w-full border border-gray-300 p-1 rounded" multiple>
          <option value="All" selected>All</option>
          ${options}
        </select>
      </div>
    `;
  }

  function filterStories(epicId) {
    const epic = epics.find(e => e.id === epicId);
    if (!epic) return;

    const pmFilter = getSelectedValues(`productManager-filter-${epicId}`);
    const sprintFilter = getSelectedValues(`sprint-filter-${epicId}`);
    const statusFilter = getSelectedValues(`status-filter-${epicId}`);
    const universityFilter = getSelectedValues(`university-filter-${epicId}`);
    const skillSetFilter = getSelectedValues(`skillSet-filter-${epicId}`);

    const filtered = epic.stories.filter(story =>
      (pmFilter.length === 0 || pmFilter.includes(story.productManager)) &&
      (sprintFilter.length === 0 || sprintFilter.includes(story.sprint)) &&
      (statusFilter.length === 0 || statusFilter.includes(story.status)) &&
      (universityFilter.length === 0 || universityFilter.includes(story.university)) &&
      (skillSetFilter.length === 0 || skillSetFilter.includes(story.skillSet))
    );

    const tableBody = document.getElementById(`story-table-${epicId}`);
    tableBody.innerHTML = filtered.map(s => `
      <tr>
        <td>${s.issueKey}</td>
        <td>${s.summary}</td>
        <td>${s.sprint}</td>
        <td>${s.status}</td>
        <td>${s.storyPoints}</td>
        <td>${s.university}</td>
        <td>${s.skillSet}</td>
      </tr>
    `).join("");
  }

  function sortTable(epicId, field) {
    const epic = epics.find(e => e.id === epicId);
    if (!epic) return;

    const key = `${epicId}-${field}`;
    const current = sortStates[key] || 'asc';

    epic.stories.sort((a, b) => {
      let valA = a[field] ?? "";
      let valB = b[field] ?? "";

      if (field === "storyPoints") {
        valA = parseFloat(valA) || 0;
        valB = parseFloat(valB) || 0;
      } else {
        valA = valA.toString().toLowerCase();
        valB = valB.toString().toLowerCase();
      }

      if (valA < valB) return current === 'asc' ? -1 : 1;
      if (valA > valB) return current === 'asc' ? 1 : -1;
      return 0;
    });

    sortStates[key] = current === 'asc' ? 'desc' : 'asc';

    const tableBody = document.getElementById(`story-table-${epicId}`);
    tableBody.innerHTML = epic.stories.map(s => `
      <tr>
        <td>${s.issueKey}</td>
        <td>${s.summary}</td>
        <td>${s.sprint}</td>
        <td>${s.status}</td>
        <td>${s.storyPoints}</td>
        <td>${s.university}</td>
        <td>${s.skillSet}</td>
      </tr>
    `).join("");
  }

  // ---------- ENVIRONMENT TOGGLE: JSON vs API ----------
  (function initModeToggle() {
    const jsonPanel = document.getElementById('json-mode-panel');
    const apiPanel = document.getElementById('api-mode-panel');
    const buttons = document.querySelectorAll('[data-mode-toggle]');

    function setMode(mode) {
      buttons.forEach(btn => {
        const isActive = btn.getAttribute('data-mode-toggle') === mode;
        btn.classList.toggle('active', isActive);
      });

      if (mode === 'json') {
        jsonPanel.classList.remove('hidden');
        apiPanel.classList.add('hidden');
      } else {
        jsonPanel.classList.add('hidden');
        apiPanel.classList.remove('hidden');
      }
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-mode-toggle');
        setMode(mode);
      });
    });

    // default mode
    setMode('json');
  })();

  // ---------- JIRA API FETCH + MAPPING ----------
  document.getElementById('jira-fetch-btn').addEventListener('click', fetchFromJira);

  async function fetchFromJira() {
    const baseUrl = document.getElementById('jira-url').value.trim().replace(/\/$/, '');
    const email = document.getElementById('jira-email').value.trim();
    const token = document.getElementById('jira-token').value.trim();
    const jql = document.getElementById('jira-jql').value.trim()
      || 'project = PEJ AND issuetype in (Epic, Story) ORDER BY created DESC';

    if (!baseUrl || !email || !token) {
      alert('Please fill Jira URL, email and API token.');
      return;
    }

    const authHeader = 'Basic ' + btoa(email + ':' + token);
    document.getElementById('loading').classList.remove('hidden');

    try {
      const url = baseUrl + '/rest/api/3/search';
      const body = JSON.stringify({
        jql: jql,
        maxResults: 1000,
        fields: [
          'summary',
          'issuetype',
          'status',
          'parent',
          'sprint',
          // TODO: replace these with your actual customfield IDs
          'customfield_10016',   // Story Points (example)
          'customfield_PM',      // Product Manager
          'customfield_UNI',     // University Name
          'customfield_SKILL',   // Skill Set
          'duedate'              // Due Date (using standard field here)
        ]
      });

      const resp = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': authHeader,
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body
      });

      if (!resp.ok) {
        const text = await resp.text();
        throw new Error('Jira API error: ' + resp.status + ' ' + text);
      }

      const data = await resp.json();
      const normalized = data.issues.map(mapJiraIssueToDashboardShape);

      processData(normalized);
      showDashboard();
    } catch (err) {
      console.error(err);
      alert('Error calling Jira: ' + err.message + '\n\nNote: If you opened this file directly from disk (file://), CORS may block Jira. Host it on a web server or use a proxy.');
    } finally {
      document.getElementById('loading').classList.add('hidden');
    }
  }

  function mapJiraIssueToDashboardShape(issue) {
    const f = issue.fields || {};

    // TODO: replace these with your actual Jira customfield IDs
    const STORY_POINTS_FIELD = 'customfield_10016';  // Story Points
    const PRODUCT_MANAGER_FIELD = 'customfield_PM';  // Product Manager
    const UNIVERSITY_FIELD = 'customfield_UNI';      // University Name
    const SKILLSET_FIELD = 'customfield_SKILL';      // Skill Set
    const SPRINT_FIELD = 'customfield_10020';        // Typical Sprint field; adjust as needed

    // Sprint (name)
    let sprintName = "";
    const sprintVal = f[SPRINT_FIELD] || f.sprint;
    if (Array.isArray(sprintVal) && sprintVal.length) {
      sprintName = sprintVal[0].name || "";
    } else if (sprintVal && sprintVal.name) {
      sprintName = sprintVal.name;
    }

    const parent = f.parent || null;

    // Map into the same shape your JSON export uses, so processData() doesn't change
    return {
      "Issue key": issue.key,
      "Issue id": issue.id,
      "Issue Type": f.issuetype ? f.issuetype.name : "",
      "Summary": f.summary || "",
      "Status": f.status ? f.status.name : "",
      "Parent key": parent ? parent.key : "",
      "Parent summary": parent && parent.fields ? parent.fields.summary : "",
      "Sprint": sprintName,

      // Match your existing field names
      "Custom field (Story Points)__1": f[STORY_POINTS_FIELD] || 0,
      "Custom field (Product Manager)": f[PRODUCT_MANAGER_FIELD] || "",
      "Custom field (University Name)": f[UNIVERSITY_FIELD] || "",
      "Custom field (Skill Set)": f[SKILLSET_FIELD] || "",
      "Custom field (Due Date)": f.duedate || ""
    };
  }
</script>

</body>
</html>
